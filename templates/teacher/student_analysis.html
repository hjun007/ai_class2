<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿåˆ†æ - AIè¯¾ç¨‹åŠ©æ‰‹ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-blue-600">ğŸ” å­¦ç”Ÿåˆ†æ - {{ student_id }}</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/teacher/statistics" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-200">
                        è¿”å›ç»Ÿè®¡åˆ†æ
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-7xl mx-auto">
            <!-- åŸºç¡€ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                    <div class="text-3xl font-bold text-blue-600 mb-2">{{ analysis_data.basic_stats.total_exams }}</div>
                    <div class="text-gray-600">è€ƒè¯•æ¬¡æ•°</div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                    <div class="text-3xl font-bold text-green-600 mb-2">{{ analysis_data.basic_stats.average_score }}</div>
                    <div class="text-gray-600">å¹³å‡åˆ†</div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                    <div class="text-3xl font-bold text-purple-600 mb-2">{{ analysis_data.basic_stats.success_rate }}%</div>
                    <div class="text-gray-600">æ­£ç¡®ç‡</div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                    <div class="text-3xl font-bold text-orange-600 mb-2">{{ analysis_data.basic_stats.total_score }}/{{ analysis_data.basic_stats.total_max_score }}</div>
                    <div class="text-gray-600">æ€»å¾—åˆ†</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- è€ƒè¯•è¶‹åŠ¿å›¾ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">è€ƒè¯•æˆç»©è¶‹åŠ¿</h3>
                    <canvas id="trendChart" width="400" height="300"></canvas>
                </div>

                <!-- é”™è¯¯åˆ†æå›¾ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">é”™è¯¯é¢˜ç›®åˆ†ç±»</h3>
                    {% if analysis_data.error_patterns %}
                    <canvas id="errorChart" width="400" height="300"></canvas>
                    {% else %}
                    <div class="flex items-center justify-center h-64 text-gray-500">
                        <div class="text-center">
                            <div class="text-4xl mb-2">ğŸ‰</div>
                            <p>æ­å–œï¼è¯¥å­¦ç”Ÿæš‚æ— é”™è¯¯è®°å½•</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- AIæ™ºèƒ½åˆ†æ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">AIæ™ºèƒ½åˆ†ææŠ¥å‘Š</h3>
                    <button 
                        onclick="generateAnalysis()" 
                        id="generateBtn"
                        class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-6 py-2 rounded-lg font-medium transition duration-200 flex items-center space-x-2"
                    >
                        <span>ğŸ¤–</span>
                        <span>ç”Ÿæˆåˆ†ææŠ¥å‘Š</span>
                    </button>
                </div>

                <!-- åˆ†æç»“æœåŒºåŸŸ -->
                <div id="analysisResult" class="hidden">
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6 border-l-4 border-purple-500">
                        <div id="analysisContent" class="prose max-w-none"></div>
                    </div>
                </div>

                <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                <div id="loadingIndicator" class="hidden flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                    <span class="ml-3 text-gray-600">AIæ­£åœ¨åˆ†æä¸­...</span>
                </div>

                <!-- é»˜è®¤æç¤º -->
                <div id="defaultPrompt" class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-4">ğŸ¤–</div>
                    <p class="text-lg">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ï¼Œè®©AIä¸ºè¯¥å­¦ç”Ÿç”Ÿæˆä¸“ä¸šçš„å­¦ä¹ åˆ†ææŠ¥å‘Š</p>
                    <p class="text-sm mt-2">æŠ¥å‘Šå°†åŒ…å«å­¦ä¹ è¡¨ç°è¯„ä»·ã€å¼ºå¼±é¡¹åˆ†æã€æ”¹è¿›å»ºè®®ç­‰å†…å®¹</p>
                </div>
            </div>

            <!-- è¯¦ç»†ç­”é¢˜æƒ…å†µ -->
            {% if analysis_data.papers_analysis %}
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">è¯¦ç»†ç­”é¢˜æƒ…å†µ</h3>
                
                {% for paper_id, questions in analysis_data.papers_analysis.items() %}
                <div class="mb-8">
                    <h4 class="text-lg font-medium text-gray-700 mb-4">è¯•å·ï¼š{{ questions[0].paper_name }}</h4>
                    
                    <div class="space-y-4">
                        {% for question in questions %}
                        <div class="border-l-4 {{ 'border-green-500 bg-green-50' if question.is_correct else 'border-red-500 bg-red-50' }} p-4 rounded-r-lg">
                            <div class="flex justify-between items-start mb-3">
                                <h5 class="font-medium text-gray-800">é¢˜ç›®å†…å®¹</h5>
                                <span class="{{ 'text-green-600' if question.is_correct else 'text-red-600' }} font-medium">
                                    {{ 'âœ… æ­£ç¡®' if question.is_correct else 'âŒ é”™è¯¯' }}
                                    ({{ question.score }}åˆ†)
                                </span>
                            </div>
                            
                            <p class="text-gray-700 mb-3">{{ question.question_content }}</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div class="p-3 {{ 'bg-red-100' if not question.is_correct else 'bg-green-100' }} rounded">
                                    <span class="font-medium text-gray-700">å­¦ç”Ÿç­”æ¡ˆï¼š</span>
                                    <span class="text-gray-800">{{ question.student_answer }}</span>
                                </div>
                                <div class="p-3 bg-green-100 rounded">
                                    <span class="font-medium text-gray-700">æ­£ç¡®ç­”æ¡ˆï¼š</span>
                                    <span class="text-green-800 font-medium">{{ question.correct_answer }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // ç»˜åˆ¶è€ƒè¯•è¶‹åŠ¿å›¾
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        const examTrends = {{ analysis_data.exam_trends|tojson|safe }};
        
        const trendLabels = examTrends.map(item => item.date);
        const trendRates = examTrends.map(item => item.rate);
        
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'æ­£ç¡®ç‡(%)',
                    data: trendRates,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });

        // ç»˜åˆ¶é”™è¯¯åˆ†æå›¾
        {% if analysis_data.error_patterns %}
        const errorCtx = document.getElementById('errorChart').getContext('2d');
        const errorPatterns = {{ analysis_data.error_patterns|tojson|safe }};
        
        const errorLabels = errorPatterns.map(item => item.category);
        const errorCounts = errorPatterns.map(item => item.error_count);
        
        new Chart(errorCtx, {
            type: 'doughnut',
            data: {
                labels: errorLabels,
                datasets: [{
                    data: errorCounts,
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(147, 51, 234, 0.8)',
                        'rgba(59, 130, 246, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        {% endif %}

        // AIåˆ†æåŠŸèƒ½
        async function generateAnalysis() {
            const generateBtn = document.getElementById('generateBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const analysisResult = document.getElementById('analysisResult');
            const defaultPrompt = document.getElementById('defaultPrompt');
            const analysisContent = document.getElementById('analysisContent');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            generateBtn.disabled = true;
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            loadingIndicator.classList.remove('hidden');
            defaultPrompt.classList.add('hidden');
            analysisResult.classList.add('hidden');
            
            try {
                const response = await fetch('/teacher/api/generate_student_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        student_id: '{{ student_id }}'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ä½¿ç”¨marked.jsæ¸²æŸ“Markdown
                    analysisContent.innerHTML = marked.parse(data.analysis);
                    analysisResult.classList.remove('hidden');
                } else {
                    analysisContent.innerHTML = '<div class="text-red-600">åˆ†æç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
                    analysisResult.classList.remove('hidden');
                }
            } catch (error) {
                analysisContent.innerHTML = '<div class="text-red-600">ç½‘ç»œé”™è¯¯ï¼š' + error.message + '</div>';
                analysisResult.classList.remove('hidden');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                loadingIndicator.classList.add('hidden');
            }
        }
    </script>
</body>
</html> 